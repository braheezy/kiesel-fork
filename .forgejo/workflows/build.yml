name: Build

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: docker
    container:
      image: ghcr.io/catthehacker/ubuntu:act-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: https://github.com/goto-bus-stop/setup-zig@v2
      - name: Create build.sh script
        run: |
          cat > build.sh << EOF
          #!/bin/bash
          zig build -Dtarget=\$1 -Doptimize=ReleaseSafe
          # Doesn't apply to Wasm build
          if [ -f zig-out/bin/kiesel ]; then
            mv zig-out/bin/kiesel zig-out/bin/\$2
          fi
          EOF
          chmod +x build.sh
      - name: Create upload.sh script
        run: |
          cat > upload.sh << EOF
          #!/bin/bash
          curl \
            -u "${{ secrets.ARTIFACT_UPLOAD_USER }}:${{ secrets.ARTIFACT_UPLOAD_PASSWORD }}" \
            -F "path=@\$1" \
            "https://files.kiesel.dev/upload?path=/files"
          EOF
          chmod +x upload.sh
      - name: Build and upload kiesel-linux-aarch64
        run: |
          ./build.sh aarch64-linux-gnu kiesel-linux-aarch64
          ./upload.sh zig-out/bin/kiesel-linux-aarch64
      - name: Build and upload kiesel-linux-x86
        run: |
          ./build.sh x86-linux-gnu kiesel-linux-x86
          ./upload.sh zig-out/bin/kiesel-linux-x86
      - name: Build and upload kiesel-linux-x86_64
        run: |
          ./build.sh x86_64-linux-gnu kiesel-linux-x86_64
          ./upload.sh zig-out/bin/kiesel-linux-x86_64
      - name: Build and upload kiesel.wasm
        run: |
          ./build.sh wasm32-wasi
          ./upload.sh zig-out/bin/kiesel.wasm
      - name: Update version.txt
        run: |
          git rev-parse main > version.txt
          ./upload.sh version.txt
